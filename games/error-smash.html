<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Error Smash</title>
  <link rel="stylesheet" href="../styles.css" />
  <style>
    .gameWrap{display:grid; gap:14px;}
    .bigCard{padding:18px; border-radius:18px; border:1px solid var(--line); background:#fff; box-shadow:var(--shadow);}
    .prompt{font-size:22px; font-weight:850; line-height:1.25;}
    .choices{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px;}
    @media (max-width:720px){.choices{grid-template-columns:1fr;}}

    .choice{
      padding:12px 12px; border-radius:14px; border:1px solid var(--line);
      background:#fff; cursor:pointer; font-weight:800; text-align:left;
    }
    .choice:hover{filter:brightness(0.98);}
    .choice.correct{outline:3px solid #bff0d5;}
    .choice.wrong{outline:3px solid #ffc2c2;}

    .metaRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .chip{padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:var(--pill); font-size:12px; font-weight:800;}

    .twoCol{display:grid; grid-template-columns:1.2fr .8fr; gap:14px;}
    @media (max-width:900px){.twoCol{grid-template-columns:1fr;}}

    /* Teacher controls now live UNDER the answers (closer!) */
    .teacherBar{display:none; margin-top:12px; gap:10px; flex-wrap:wrap;}
    .teacherBar.show{display:flex;}
    .miniBtn{
      padding:10px 12px; border-radius:14px; border:1px solid var(--line);
      background:#fff; font-weight:850; cursor:pointer;
    }
    .miniBtn.primary{background:var(--btn); color:#fff; border-color:transparent;}
    .teamBtn{width:100%; text-align:left;}

    .reviewBox{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .reviewItem{
      border-top:1px solid var(--line);
      padding-top:10px;
      margin-top:10px;
    }
    .reviewItem:first-child{
      border-top:none;
      padding-top:0;
      margin-top:0;
    }
    .tag{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--pill);
      font-size:12px;
      font-weight:800;
      margin-right:6px;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">ES</div>
      <div>
        <div class="brand-title">Error Smash</div>
        <div class="brand-sub" id="subTitle">Loading…</div>
      </div>
    </div>
    <div class="topbar-actions">
      <button class="ghost" id="btnBack">Home</button>
    </div>
  </header>

  <main class="container gameWrap">
    <section class="card">
      <div class="metaRow">
        <span class="chip" id="chipMode"></span>
        <span class="chip" id="chipCalm"></span>
        <span class="chip" id="chipPack"></span>
        <span class="chip" id="chipProgress"></span>
      </div>
    </section>

    <section class="twoCol">
      <div class="bigCard" id="mainCard">
        <div class="prompt" id="prompt">…</div>
        <div class="choices" id="choices"></div>
        <div style="margin-top:12px" class="muted" id="feedback"></div>

        <!-- Teacher controls moved here (close to answers) -->
        <div class="teacherBar" id="teacherBar">
          <button class="miniBtn" id="btnReveal">Reveal</button>
          <button class="miniBtn" id="btnSkip">Skip</button>
          <button class="miniBtn primary" id="btnNext">Next</button>
          <button class="miniBtn" id="btnEnd">End Game</button>
        </div>
      </div>

      <div class="bigCard">
        <h3 class="h3">Team Leaderboard</h3>
        <div id="teams"></div>
        <hr class="sep" />
        <div class="muted small" id="microRule"></div>
      </div>
    </section>
  </main>

<script>
const STORAGE = { teacherSession: "gg_teacher_session" };

function qs(){ return new URLSearchParams(location.search); }
function $(id){ return document.getElementById(id); }
function escapeHtml(str){
  return (str ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function loadTeacherSession(){
  const raw = localStorage.getItem(STORAGE.teacherSession);
  return raw ? JSON.parse(raw) : null;
}
function saveTeacherSession(session){
  localStorage.setItem(STORAGE.teacherSession, JSON.stringify(session));
}

let PACK = null;
let items = [];
let idx = 0;
let revealed = false;
let teacher = false;

// Track performance for end-of-game teacher review
// keyed by original prompt string
const attemptLog = new Map(); // prompt -> { wrongPicks:Set<string>, correct:string, rule:string }
const incorrectPrompts = new Set(); // prompts where student/teams made at least one wrong pick

function ensureLogForItem(item){
  if(!attemptLog.has(item.prompt)){
    attemptLog.set(item.prompt, {
      wrongPicks: new Set(),
      correct: item.choices[item.answer],
      rule: item.rule || PACK.microRules?.default || ""
    });
  }
  return attemptLog.get(item.prompt);
}

function renderTeams(session){
  const wrap = $("teams");
  wrap.innerHTML = "";

  const sorted = [...session.teams].sort((a,b)=>b.score-a.score);
  sorted.forEach((t, i)=>{
    const div = document.createElement("div");
    div.className = "badge";
    div.innerHTML = `
      <span class="dot ${i===0 ? "good" : ""}"></span>
      <div style="width:100%">
        <div class="kpi"><span>${i+1}. ${escapeHtml(t.name)}</span><span>${t.score}</span></div>
        <div class="muted small">${t.correct} correct • ${t.wrong} try-agains</div>
      </div>
    `;
    wrap.appendChild(div);
  });

  if(teacher){
    const scoreBox = document.createElement("div");
    scoreBox.style.marginTop = "12px";
    scoreBox.innerHTML = `<div class="muted small" style="margin-bottom:8px">Teacher: award points to the team who answered.</div>`;
    session.teams.forEach((t, tIdx)=>{
      const b = document.createElement("button");
      b.className = "miniBtn teamBtn";
      b.textContent = `+10 to ${t.name}`;
      b.onclick = ()=>{
        session.teams[tIdx].score += 10;
        session.teams[tIdx].correct += 1;
        saveTeacherSession(session);
        renderTeams(session);
      };
      scoreBox.appendChild(b);

      const b2 = document.createElement("button");
      b2.className = "miniBtn teamBtn";
      b2.textContent = `+6 (2nd try) to ${t.name}`;
      b2.onclick = ()=>{
        session.teams[tIdx].score += 6;
        session.teams[tIdx].correct += 1;
        session.teams[tIdx].wrong += 1;
        saveTeacherSession(session);
        renderTeams(session);
      };
      scoreBox.appendChild(b2);
    });
    wrap.appendChild(scoreBox);
  }
}

function setFeedback(type, text){
  const el = $("feedback");
  el.textContent = text;
  el.style.color = type === "good" ? "var(--good)" : type === "bad" ? "var(--bad)" : "var(--muted)";
}

function updateProgress(){
  $("chipProgress").textContent = `Q ${idx+1} / ${items.length}`;
}

function showItem(){
  revealed = false;
  updateProgress();

  const item = items[idx];
  ensureLogForItem(item);

  setFeedback("neutral", "Choose the best correction. It’s okay to try again.");
  $("prompt").innerHTML = escapeHtml(item.prompt);
  $("microRule").textContent = item.rule || PACK.microRules?.default || "";
  $("subTitle").textContent = PACK.title;

  const choices = $("choices");
  choices.innerHTML = "";
  item.choices.forEach((c, i)=>{
    const btn = document.createElement("button");
    btn.className = "choice";
    btn.innerHTML = escapeHtml(c);
    btn.onclick = ()=> onChoice(i, btn);
    choices.appendChild(btn);
  });
}

function markAnswer(correctIndex){
  const choiceButtons = [...document.querySelectorAll(".choice")];
  choiceButtons.forEach((b, i)=>{
    if(i === correctIndex) b.classList.add("correct");
  });
}

function onChoice(i, btn){
  if(revealed) return;

  const item = items[idx];
  const log = ensureLogForItem(item);

  if(i === item.answer){
    btn.classList.add("correct");
    setFeedback("good", "Nice catch. You fixed the grammar!");
    revealed = true;
  }else{
    // log incorrect
    incorrectPrompts.add(item.prompt);
    log.wrongPicks.add(item.choices[i]);

    btn.classList.add("wrong");
    setFeedback("bad", "Almost. Try again—look at the verb form and time signal.");
  }
}

function reveal(){
  const item = items[idx];
  ensureLogForItem(item);

  revealed = true;
  markAnswer(item.answer);
  setFeedback("neutral", "Answer revealed. Ask: Why is this form correct?");
}

function next(){
  idx = (idx + 1) % items.length;
  showItem();
}

function skip(){
  next();
}

function showSummary(){
  const session = loadTeacherSession();
  const teams = session?.teams || [];
  const sorted = [...teams].sort((a,b)=>b.score-a.score);
  const winner = sorted[0];

  const totalCorrect = teams.reduce((s,t)=>s+t.correct,0);
  const totalTryAgain = teams.reduce((s,t)=>s+t.wrong,0);

  // Build review section: incorrect prompts + correct correction + what they picked
  const incorrectList = [...incorrectPrompts].map(p => ({
    prompt: p,
    ...attemptLog.get(p)
  }));

  // Keep it readable: show up to 10 (teacher can expand later if needed)
  const maxShow = 10;
  const shown = incorrectList.slice(0, maxShow);
  const hiddenCount = Math.max(0, incorrectList.length - maxShow);

  let reviewHtml = "";
  if(incorrectList.length === 0){
    reviewHtml = `<div class="muted">No incorrect answers were recorded. (Amazing.)</div>`;
  } else {
    reviewHtml = shown.map((it, n)=>{
      const wrongs = [...(it.wrongPicks || [])];
      const wrongText = wrongs.length
        ? wrongs.map(w=>`<span class="tag">Picked</span> ${escapeHtml(w)}`).join("<br/>")
        : `<span class="muted">No wrong pick recorded (maybe revealed/skip).</span>`;

      return `
        <div class="reviewItem">
          <div class="muted small"><strong>#${n+1}</strong></div>
          <div style="margin:6px 0 8px; font-weight:900">${escapeHtml(it.prompt)}</div>
          <div style="margin:8px 0">
            <span class="tag">Correct</span> <strong>${escapeHtml(it.correct)}</strong>
          </div>
          <div style="margin:8px 0">${wrongText}</div>
          ${it.rule ? `<div class="muted small" style="margin-top:8px"><strong>Quick rule:</strong> ${escapeHtml(it.rule)}</div>` : ""}
        </div>
      `;
    }).join("");

    if(hiddenCount > 0){
      reviewHtml += `<div class="muted small" style="margin-top:10px">(+${hiddenCount} more missed items not shown)</div>`;
    }
  }

  $("mainCard").innerHTML = `
    <h2 style="margin:0 0 8px">Game Summary</h2>
    <p class="muted" style="margin:0 0 14px">Quick recap + what to review.</p>

    <div class="badge" style="margin-bottom:10px; width:100%">
      <span class="dot good"></span>
      <div style="width:100%">
        <div class="kpi">
          <span><strong>Winning Team:</strong> ${winner ? escapeHtml(winner.name) : "—"}</span>
          <span>${winner ? winner.score : 0}</span>
        </div>
        <div class="muted small">Total correct: ${totalCorrect} • Try-agains: ${totalTryAgain}</div>
      </div>
    </div>

    <div class="reviewBox">
      <div style="font-weight:900; margin-bottom:8px">Teacher Review: Missed Items</div>
      ${reviewHtml}
    </div>

    <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="miniBtn primary" onclick="location.href='../index.html#teacher'">Return to Lobby</button>
      <button class="miniBtn" onclick="location.reload()">Play Again (same settings)</button>
    </div>
  `;
}

async function init(){
  const p = qs().get("pack");
  const packId = qs().get("packId") || "";
  const mode = qs().get("mode") || "whole";
  const calm = qs().get("calm") === "1";
  teacher = qs().get("teacher") === "1";

  $("chipMode").textContent = mode === "whole" ? "Whole Class" : "Solo";
  $("chipCalm").textContent = calm ? "Calm Mode: ON" : "Calm Mode: OFF";
  $("chipPack").textContent = packId;

  if(teacher) $("teacherBar").classList.add("show");

  $("btnBack").onclick = ()=> location.href = "../index.html#teacher";

  const res = await fetch("../" + p);
  PACK = await res.json();

  items = (PACK.games?.errorSmash?.items || []).slice();
  items.sort(()=> Math.random() - 0.5);

  idx = 0;
  showItem();

  const session = loadTeacherSession();
  if(session) renderTeams(session);

  $("btnNext").onclick = next;
  $("btnReveal").onclick = reveal;
  $("btnSkip").onclick = skip;
  $("btnEnd").onclick = showSummary;
}

init().catch(err=>{
  console.error(err);
  alert("Error loading the game. " + err.message);
});
</script>
</body>
</html>
